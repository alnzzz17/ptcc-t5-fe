<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
</head>

<body class="bg-gray-200">
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-light shadow-sm px-4">
        <span class="navbar-brand mb-0 h1 fw-bold">TWO-LIST</span>
        <div class="d-flex gap-3">
            <button class="btn btn-light d-flex align-items-center gap-2" id="accountBtn">
                Account
            </button>
            <button class="btn btn-light text-danger d-flex align-items-center gap-2" onclick="handleLogout()">
                Logout
            </button>
        </div>
    </nav>

    <!-- Welcome Section -->
    <div class="text-center mt-4">
        <h2 class="fw-bold">WELCOME, <span id="fullName">USER</span>!</h2>
        <button class="btn btn-success my-3" onclick="openCreateModal()">NEW NOTE</button>
    </div>

    <!-- Notes Section -->
    <div class="container">
        <div class="row row-cols-1 row-cols-md-3 g-4" id="notes-container">
            <!-- Notes will be displayed here -->
        </div>
    </div>

    <!-- Modal Tambah/Edit Note -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <!-- Modal content remains the same -->
    </div>

    <!-- Modal Edit Akun -->
    <div class="modal fade" id="accountModal" tabindex="-1">
        <!-- Modal content remains the same -->
    </div>

    <script src="./js/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, isError = false, elementId = 'notificationArea') {
            const notificationArea = document.getElementById(elementId);
            if (!notificationArea) return;

            notificationArea.style.display = 'block';
            notificationArea.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
            notificationArea.textContent = message;

            setTimeout(() => {
                notificationArea.style.display = 'none';
            }, 3000);
        }

        // Fungsi untuk decode token JWT
        function decodeToken(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error("Invalid token", error);
                return null;
            }
        }

        // Fungsi untuk memeriksa token dan redirect jika tidak valid
        function checkAuth() {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                window.location.href = './login.html';
                return false;
            }
            return true;
        }

        // Fungsi untuk membuat header authorization
        function getAuthHeaders() {
            const accessToken = localStorage.getItem('accessToken');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            };
        }

        // dashboard.js
        document.addEventListener('DOMContentLoaded', () => {
            // Cek autentikasi
            if (!checkAuth()) return;

            // Ambil data user
            const userData = JSON.parse(localStorage.getItem('userData')) || {};
            document.getElementById('fullName').innerText = userData.fullName || 'User';

            // Inisialisasi modal
            const noteModal = new bootstrap.Modal(document.getElementById('noteModal'));
            const accountModal = new bootstrap.Modal(document.getElementById('accountModal'));

            // Fungsi logout
            function handleLogout() {
                if (confirm("Are you sure you want to logout?")) {
                    fetch(`${BASE_URL}/user/logout`, {
                        method: 'POST',
                        credentials: 'include'
                    }).finally(() => {
                        localStorage.clear();
                        window.location.href = './login.html';
                    });
                }
            }

            // Event listener untuk tombol logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Event listener untuk tombol account
            document.getElementById('accountBtn').addEventListener('click', function () {
                document.getElementById('editUsername').value = userData.username || '';
                document.getElementById('editFullName').value = userData.fullName || '';
                document.getElementById('editPassword').value = '';
                accountModal.show();
            });

            // Toggle password visibility
            const passwordInput = document.getElementById('editPassword');
            const togglePassword = document.getElementById('togglePassword');
            if (togglePassword) {
                togglePassword.addEventListener('click', () => {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        togglePassword.textContent = 'Hide';
                    } else {
                        passwordInput.type = 'password';
                        togglePassword.textContent = 'Show';
                    }
                });
            }

            // Handle form submission (Update user data)
            document.getElementById('accountForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const updatedData = {
                    username: document.getElementById('editUsername').value,
                    fullName: document.getElementById('editFullName').value,
                    password: document.getElementById('editPassword').value
                };

                fetch(`${BASE_URL}/user/edit`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(updatedData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showNotification('Account updated successfully!', false);
                            // Update user data in localStorage
                            if (data.data) {
                                localStorage.setItem('userData', JSON.stringify(data.data));
                                document.getElementById('fullName').innerText = data.data.fullName;
                            }
                            accountModal.hide();
                        } else {
                            showNotification(data.message || 'Error updating account', true);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('An error occurred while updating account', true);
                    });
            });

            // Fungsi untuk menghapus akun
            document.getElementById('deleteAccountBtn').addEventListener('click', function () {
                if (confirm("Are you sure you want to delete your account? This action cannot be undone.")) {
                    fetch(`${BASE_URL}/user/delete/${userData.id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                localStorage.clear();
                                window.location.href = './login.html';
                            } else {
                                showNotification(data.message || 'Failed to delete account', true);
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting account:', error);
                            showNotification('An error occurred while deleting account', true);
                        });
                }
            });

            // Fungsi untuk mengambil dan menampilkan catatan
            function fetchNotes() {
                fetch(`${BASE_URL}/notes/all`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch notes');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            displayNotes(data.data);
                        } else {
                            showNotification(data.message || 'Failed to fetch notes', true);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching notes:', error);
                        showNotification('Failed to fetch notes', true);
                    });
            }

            // Fungsi untuk menampilkan catatan
            function displayNotes(notes) {
                const container = document.getElementById('notes-container');
                container.innerHTML = '';

                if (!notes || notes.length === 0) {
                    container.innerHTML = '<p class="text-center">No notes found. Create your first note!</p>';
                    return;
                }

                notes.forEach(note => {
                    const noteCard = document.createElement('div');
                    noteCard.className = 'col';
                    noteCard.innerHTML = `
                <div class="card shadow-sm rounded-lg note-card">
                    <div class="card-header fw-bold">${note.noteTitle}</div>
                    <div class="card-body">
                        <p class="card-text text-muted note-content">${note.noteContent.replace(/\n/g, '<br>')}</p>
                        <div class="d-flex justify-content-center button-container">
                            <button class="btn btn-danger" onclick="deleteNote(${note.id})">DELETE</button>
                            <button class="btn btn-primary" onclick="openEditModal(${note.id}, '${note.noteTitle.replace(/'/g, "\\'")}', '${note.noteContent.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')">EDIT</button>
                        </div>
                    </div>
                </div>
            `;
                    container.appendChild(noteCard);
                });
            }

            // Fungsi untuk membuka modal tambah catatan
            window.openCreateModal = function () {
                document.getElementById('modalTitle').innerText = 'New Note';
                document.getElementById('noteId').value = '';
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                noteModal.show();
            };

            // Fungsi untuk membuka modal edit catatan
            window.openEditModal = function (id, title, content) {
                document.getElementById('modalTitle').innerText = 'Edit Note';
                document.getElementById('noteId').value = id;
                document.getElementById('noteTitle').value = title;
                document.getElementById('noteContent').value = content.replace(/\\n/g, '\n');
                noteModal.show();
            };

            // Fungsi untuk menyimpan catatan
            window.saveNote = function () {
                const noteId = document.getElementById('noteId').value;
                const noteTitle = document.getElementById('noteTitle').value;
                const noteContent = document.getElementById('noteContent').value;

                if (!noteTitle) {
                    showNotification('Note title is required', true, 'noteNotification');
                    return;
                }

                const method = noteId ? 'PUT' : 'POST';
                const url = noteId ? `${BASE_URL}/notes/${noteId}` : `${BASE_URL}/notes/new`;

                fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ noteTitle, noteContent })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            fetchNotes();
                            noteModal.hide();
                            showNotification('Note saved successfully!', false);
                        } else {
                            showNotification(data.message || 'Failed to save note', true, 'noteNotification');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving note:', error);
                        showNotification('An error occurred while saving the note', true, 'noteNotification');
                    });
            };

            // Fungsi untuk menghapus catatan
            window.deleteNote = function (noteId) {
                if (!confirm('Are you sure you want to delete this note?')) return;

                fetch(`${BASE_URL}/notes/delete/${noteId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            fetchNotes();
                            showNotification('Note deleted successfully!', false);
                        } else {
                            showNotification(data.message || 'Failed to delete note', true);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting note:', error);
                        showNotification('An error occurred while deleting the note', true);
                    });
            };

            // Jalankan fetchNotes saat halaman dimuat
            fetchNotes();
        });
    </script>
</body>

</html>