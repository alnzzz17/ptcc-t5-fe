<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
</head>

<body class="bg-gray-200">
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-light shadow-sm px-4">
        <span class="navbar-brand mb-0 h1 fw-bold">TWO-LIST</span>
        <div class="d-flex gap-3">
            <button class="btn btn-light d-flex align-items-center gap-2" id="accountBtn">
                Account
            </button>
            <button class="btn btn-light text-danger d-flex align-items-center gap-2" onclick="handleLogout()">
                Logout
            </button>
        </div>
    </nav>

    <!-- Welcome Section -->
    <div class="text-center mt-4">
        <h2 class="fw-bold">WELCOME, <span id="fullName">USER</span>!</h2>
        <button class="btn btn-success my-3" onclick="openCreateModal()">NEW NOTE</button>
    </div>

    <!-- Notes Section -->
    <div class="container">
        <div class="row row-cols-1 row-cols-md-3 g-4" id="notes-container">
            <!-- Notes will be displayed here -->
        </div>
    </div>

    <!-- Modal Tambah/Edit Note -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <!-- Modal content remains the same -->
    </div>

    <!-- Modal Edit Akun -->
    <div class="modal fade" id="accountModal" tabindex="-1">
        <!-- Modal content remains the same -->
    </div>

    <script src="./js/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication - using localStorage like in login
            const accessToken = localStorage.getItem('accessToken');
            const userData = JSON.parse(localStorage.getItem('userData')) || {};

            // Redirect to login if no token or user data
            if (!accessToken || !userData) {
                localStorage.clear();
                window.location.href = './login.html';
                return;
            }

            // Verify token structure before attempting to decode
            function isValidToken(token) {
                try {
                    const parts = token.split('.');
                    return parts.length === 3 &&
                        parts[0].length > 0 &&
                        parts[1].length > 0 &&
                        parts[2].length > 0;
                } catch (e) {
                    return false;
                }
            }

            if (!isValidToken(accessToken)) {
                localStorage.clear();
                window.location.href = './login.html';
                return;
            }

            // Function to decode token JWT (with better error handling)
            function decodeToken(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(
                        atob(base64)
                            .split('')
                            .map((c) => {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            })
                            .join('')
                    );
                    return JSON.parse(jsonPayload);
                } catch (error) {
                    console.error('Invalid token', error);
                    return null;
                }
            }

            // Verifikasi token dan waktu expired
            const decodedToken = decodeToken(accessToken);
            const isTokenExpired = decodedToken?.exp * 1000 < Date.now();

            if (!decodedToken || isTokenExpired) {
                localStorage.clear();
                window.location.href = './login.html';
                return;
            }

            // Set user data
            document.getElementById('fullName').innerText = userData.fullName || 'User';

            // Function to refresh token
            async function refreshAccessToken() {
                try {
                    const response = await fetch(`${BASE_URL}/user/refresh`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to refresh token');
                    }

                    const data = await response.json();
                    if (data.accessToken) {
                        localStorage.setItem('accessToken', data.accessToken);
                        return data.accessToken;
                    }
                } catch (error) {
                    console.error('Token refresh failed:', error);
                    handleLogout();
                    return null;
                }
            }

            // Function to make authenticated requests
            async function makeAuthenticatedRequest(url, options = {}) {
                let token = localStorage.getItem('accessToken');

                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                };

                try {
                    let response = await fetch(url, { ...options, headers });

                    if (response.status === 401) {
                        const newToken = await refreshAccessToken();
                        if (newToken) {
                            headers['Authorization'] = `Bearer ${newToken}`;
                            response = await fetch(url, { ...options, headers });
                        } else {
                            // Token gagal diperbarui
                            localStorage.clear();
                            window.location.href = './login.html';
                            return;
                        }
                    }

                    return response;
                } catch (error) {
                    console.error('Request failed:', error);
                    throw error;
                }
            }


            // Logout function
            async function handleLogout() {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        await makeAuthenticatedRequest(`${BASE_URL}/user/logout`, {
                            method: 'POST'
                        });
                    } catch (error) {
                        console.error('Logout failed:', error);
                    } finally {
                        localStorage.clear();
                        window.location.href = './login.html';
                    }
                }
            }

            // Function to fetch and display notes
            async function fetchNotes() {
                try {
                    const response = await makeAuthenticatedRequest(`${BASE_URL}/notes/all`);

                    // Check if response is OK
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.status === 'success') {
                        // Ensure data.data is an array
                        if (Array.isArray(data.data)) {
                            displayNotes(data.data);
                        } else {
                            console.error('Invalid notes data format:', data.data);
                            displayNotes([]); // Show empty state
                        }
                    } else {
                        console.error('Failed to fetch notes:', data.message);
                        alert('Failed to fetch notes: ' + (data.message || 'Unknown error'));
                        displayNotes([]); // Show empty state
                    }
                } catch (error) {
                    console.error('Error fetching notes:', error);
                    alert('Error fetching notes: ' + error.message);
                    displayNotes([]); // Show empty state

                    // If unauthorized, redirect to login
                    if (error.message.includes('Unauthorized') || error.message.includes('Session expired')) {
                        handleLogout();
                    }
                }
            }
            // Function to display notes
            function displayNotes(notes) {
                const container = document.getElementById('notes-container');
                if (!container) return;

                container.innerHTML = '';

                // Check if notes is an array and not empty
                if (!Array.isArray(notes) || notes.length === 0) {
                    container.innerHTML = '<p class="text-center">No notes found</p>';
                    return;
                }

                notes.forEach((note) => {
                    // Skip if note is invalid
                    if (!note || typeof note !== 'object') return;

                    const noteCard = document.createElement('div');
                    noteCard.className = 'col';

                    // Ensure note content exists before processing
                    const noteContent = note.noteContent || '';
                    const noteTitle = note.noteTitle || 'Untitled Note';

                    // Escape HTML in note content to prevent XSS
                    const escapedContent = String(noteContent)
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;")
                        .replace(/\n/g, '<br>');

                    const escapedTitle = String(noteTitle)
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");

                    // Ensure note.id exists
                    const noteId = note.id || '';

                    noteCard.innerHTML = `
            <div class="card shadow-sm rounded-lg note-card">
                <div class="card-header fw-bold">${escapedTitle}</div>
                <div class="card-body">
                    <p class="card-text text-muted note-content">${escapedContent}</p>
                    <div class="d-flex justify-content-center button-container">
                        <button class="btn btn-danger" onclick="deleteNote('${noteId}')">DELETE</button>
                        <button class="btn btn-primary" onclick="openEditModal('${noteId}', '${escapedTitle.replace(/'/g, "\\'")}', '${noteContent.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')">OPEN</button>
                    </div>
                </div>
            </div>
        `;
                    container.appendChild(noteCard);
                });
            }
            // Function to open create note modal
            function openCreateModal() {
                document.getElementById('modalTitle').innerText = 'New Note';
                document.getElementById('noteId').value = '';
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                new bootstrap.Modal(document.getElementById('noteModal')).show();
            }

            // Function to open edit note modal
            function openEditModal(id, title, content) {
                document.getElementById('modalTitle').innerText = 'Edit Note';
                document.getElementById('noteId').value = id;
                document.getElementById('noteTitle').value = title;
                document.getElementById('noteContent').value = content.replace(/\\n/g, '\n');
                new bootstrap.Modal(document.getElementById('noteModal')).show();
            }

            // Function to save note
            async function saveNote() {
                const noteId = document.getElementById('noteId').value;
                const noteTitle = document.getElementById('noteTitle').value;
                const noteContent = document.getElementById('noteContent').value;

                if (!noteTitle || !noteContent) {
                    alert('Please fill in all fields');
                    return;
                }

                try {
                    const url = noteId
                        ? `${BASE_URL}/notes/${noteId}`
                        : `${BASE_URL}/notes/new`;

                    const method = noteId ? 'PUT' : 'POST';

                    const response = await makeAuthenticatedRequest(url, {
                        method,
                        body: JSON.stringify({ noteTitle, noteContent })
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        fetchNotes();
                        bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                    } else {
                        alert('Failed to save note: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error saving note:', error);
                    alert('An error occurred while saving the note: ' + error.message);
                }
            }

            // Function to delete note
            async function deleteNote(noteId) {
                if (!confirm('Are you sure you want to delete this note?')) return;

                try {
                    const response = await makeAuthenticatedRequest(`${BASE_URL}/notes/${noteId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        fetchNotes();
                    } else {
                        alert('Failed to delete note: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting note:', error);
                    alert('An error occurred while deleting the note: ' + error.message);
                }
            }

            // Function to update account
            async function updateAccount() {
                const username = document.getElementById('editUsername').value;
                const fullName = document.getElementById('editFullName').value;
                const password = document.getElementById('editPassword').value;

                if (!username || !fullName) {
                    alert('Username and full name are required');
                    return;
                }

                try {
                    const response = await makeAuthenticatedRequest(`${BASE_URL}/user/edit`, {
                        method: 'PUT',
                        body: JSON.stringify({ username, fullName, password })
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        alert('Account updated successfully!');
                        // Update user data in localStorage
                        if (data.data) {
                            localStorage.setItem('userData', JSON.stringify(data.data));
                            document.getElementById('fullName').innerText = data.data.fullName;
                        }
                        bootstrap.Modal.getInstance(document.getElementById('accountModal')).hide();
                    } else {
                        alert('Error updating account: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error updating account:', error);
                    alert('An error occurred while updating account: ' + error.message);
                }
            }

            // Function to delete account
            async function deleteAccount() {
                if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                    try {
                        const response = await makeAuthenticatedRequest(`${BASE_URL}/user/delete/${userData.id}`, {
                            method: 'DELETE'
                        });

                        const data = await response.json();

                        if (data.status === 'success') {
                            alert('Account deleted successfully.');
                            localStorage.clear();
                            window.location.href = './login.html';
                        } else {
                            alert('Failed to delete account: ' + data.message);
                        }
                    } catch (error) {
                        console.error('Error deleting account:', error);
                        alert('An error occurred while deleting account: ' + error.message);
                    }
                }
            }

            // Initialize the page
            fetchNotes();

            // Set up event listeners
            document.getElementById('accountBtn')?.addEventListener('click', function () {
                document.getElementById('editUsername').value = userData.username || '';
                document.getElementById('editFullName').value = userData.fullName || '';
                document.getElementById('editPassword').value = '';
                new bootstrap.Modal(document.getElementById('accountModal')).show();
            });

            // Toggle password visibility
            const passwordInput = document.getElementById('editPassword');
            const togglePassword = document.getElementById('togglePassword');
            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', () => {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        togglePassword.textContent = 'Hide';
                    } else {
                        passwordInput.type = 'password';
                        togglePassword.textContent = 'Show';
                    }
                });
            }

            // Handle form submission for account update
            document.getElementById('accountForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                updateAccount();
            });

            // Handle delete account button
            document.getElementById('deleteAccountBtn')?.addEventListener('click', deleteAccount);

            // Handle note form submission
            document.getElementById('noteForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                saveNote();
            });

            // Expose functions to global scope for HTML onclick attributes
            window.deleteNote = deleteNote;
            window.openEditModal = openEditModal;
            window.openCreateModal = openCreateModal;
        });
    </script>
</body>

</html>